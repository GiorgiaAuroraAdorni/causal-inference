\documentclass[a4paper,12pt]{article} % This defines the style of your paper

\usepackage[top = 2.5cm, bottom = 2.5cm, left = 2.5cm, right = 2.5cm]{geometry} 
\usepackage[utf8]{inputenc} %utf8 % lettere accentate da tastiera
\usepackage[english]{babel} % lingua del documento
\usepackage[T1]{fontenc} % codifica dei font

\usepackage{multirow} % Multirow is for tables with multiple rows within one 
%cell.
\usepackage{booktabs} % For even nicer tables.

\usepackage{graphicx} 

\usepackage{setspace}
\setlength{\parindent}{0in}

\usepackage{float}

\usepackage{fancyhdr}

\usepackage{caption}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{color}

\usepackage[hidelinks]{hyperref}
\usepackage{csquotes}
\usepackage{subfigure}

\usepackage{ifxetex,ifluatex}
\usepackage{etoolbox}
\usepackage[svgnames]{xcolor}

\usepackage{tikz}

\usepackage{framed}

\newcommand*\quotefont{\fontfamily{LinuxLibertineT-LF}} % selects Libertine as 
%the quote font


\newcommand*\quotesize{40} % if quote size changes, need a way to make shifts 
%relative
% Make commands for the quotes
\newcommand*{\openquote}
{\tikz[remember picture,overlay,xshift=-4ex,yshift=-1ex]
	\node (OQ) 
	{\quotefont\fontsize{\quotesize}{\quotesize}\selectfont``};\kern0pt}

\newcommand*{\closequote}[1]
{\tikz[remember picture,overlay,xshift=4ex,yshift=-1ex]
	\node (CQ) {\quotefont\fontsize{\quotesize}{\quotesize}\selectfont''};}

% select a colour for the shading
\colorlet{shadecolor}{WhiteSmoke}

\newcommand*\shadedauthorformat{\emph} % define format for the author argument

% Now a command to allow left, right and centre alignment of the author
\newcommand*\authoralign[1]{%
	\if#1l
	\def\authorfill{}\def\quotefill{\hfill}
	\else
	\if#1r
	\def\authorfill{\hfill}\def\quotefill{}
	\else
	\if#1c
	\gdef\authorfill{\hfill}\def\quotefill{\hfill}
	\else\typeout{Invalid option}
	\fi
	\fi
	\fi}
% wrap everything in its own environment which takes one argument (author) and 
%one optional argument
% specifying the alignment [l, r or c]
%
\newenvironment{shadequote}[2][l]%
{\authoralign{#1}
	\ifblank{#2}
	{\def\shadequoteauthor{}\def\yshift{-2ex}\def\quotefill{\hfill}}
	{\def\shadequoteauthor{\par\authorfill\shadedauthorformat{#2}}\def\yshift{2ex}}
	\begin{snugshade}\begin{quote}\openquote}
		{\shadequoteauthor\quotefill\closequote{\yshift}\end{quote}\end{snugshade}}

\newcommand{\footref}[1]{%
	$^{\ref{#1}}$%
}

\pagestyle{fancy}

\setlength\parindent{24pt}

\fancyhf{}

\lhead{\footnotesize Artificial Intelligence: Assignment 2}

\rhead{\footnotesize Giorgia Adorni}

\cfoot{\footnotesize \thepage} 


\usepackage{xcolor}
\usepackage{listings,lstautogobble}
\definecolor{gray}{gray}{0.5}
\colorlet{commentcolour}{green!50!black}
\colorlet{stringcolour}{red!60!black}
\colorlet{keywordcolour}{blue}
\colorlet{exceptioncolour}{yellow!50!red}
\colorlet{commandcolour}{magenta!90!black}
\colorlet{numpycolour}{blue!60!green}
\colorlet{literatecolour}{magenta!90!black}
\colorlet{promptcolour}{green!50!black}
\colorlet{specmethodcolour}{violet}

\newcommand{\footlabel}[2]{%
	\addtocounter{footnote}{1}%
	\footnotetext[\thefootnote]{%
		\addtocounter{footnote}{-1}%
		\refstepcounter{footnote}\label{#1}%
		#2%
	}%
	$^{\ref{#1}}$%
}

\newcommand*{\literatecolour}{\textcolor{literatecolour}}

\newcommand*{\pythonprompt}{\textcolor{promptcolour}{{>}{>}{>}}}

\lstdefinestyle{python}{
	language=python,
	showtabs=true,
	tab=,
	tabsize=4,
	basicstyle=\ttfamily\footnotesize,
	stringstyle=\color{stringcolour},
	showstringspaces=false,
	keywordstyle=\color{keywordcolour}\bfseries,
	emph={as,and,break,class,continue,def,yield,del,elif ,else,%
		except,exec,finally,for,from,global,if,in,%
		lambda,not,or,pass,print,raise,return,try,while,assert,with},
	emphstyle=\color{blue}\bfseries,
	emph={[2]True, False, None},
	emphstyle=[3]\color{commandcolour},
	morecomment=[s]{"""}{"""},
	commentstyle=\color{commentcolour}\slshape,
	emph={array, matmul, ones, transpose, float32},
	emphstyle=[4]\color{numpycolour},
	emph={[5]assert,yield},
	emphstyle=[5]\color{keywordcolour}\bfseries,
	emph={[6]range},
	emphstyle={[6]\color{keywordcolour}\bfseries},
	literate=*%
	{:}{{\literatecolour:}}{1}%
	{=}{{\literatecolour=}}{1}%
	{-}{{\literatecolour-}}{1}%
	{+}{{\literatecolour+}}{1}%
	{*}{{\literatecolour*}}{1}%
	{**}{{\literatecolour{**}}}2%
	{/}{{\literatecolour/}}{1}%
	{//}{{\literatecolour{//}}}2%
	{!}{{\literatecolour!}}{1}%
	{<}{{\literatecolour<}}{1}%
	{>}{{\literatecolour>}}{1}%
	{>>>}{\pythonprompt}{3},
	frame=trbl,
	rulecolor=\color{black!40},
	backgroundcolor=\color{gray!5},
	breakindent=.5\textwidth,
	frame=single,
	breaklines=true,
	basicstyle=\ttfamily\footnotesize,%
	keywordstyle=\color{keywordcolour},%
	emphstyle={[7]\color{keywordcolour}},%
	emphstyle=\color{exceptioncolour},%
	literate=*%
	{:}{{\literatecolour:}}{2}%
	{=}{{\literatecolour=}}{2}%
	{-}{{\literatecolour-}}{2}%
	{+}{{\literatecolour+}}{2}%
	{*}{{\literatecolour*}}2%
	{**}{{\literatecolour{**}}}3%
	{/}{{\literatecolour/}}{2}%
	{//}{{\literatecolour{//}}}{2}%
	{!}{{\literatecolour!}}{2}%
	{<}{{\literatecolour<}}{2}%
	{<=}{{\literatecolour{<=}}}3%
	{>}{{\literatecolour>}}{2}%
	{>=}{{\literatecolour{>=}}}3%
	{==}{{\literatecolour{==}}}3%
	{!=}{{\literatecolour{!=}}}3%
	{+=}{{\literatecolour{+=}}}3%
	{-=}{{\literatecolour{-=}}}3%
	{*=}{{\literatecolour{*=}}}3%
	{/=}{{\literatecolour{/=}}}3%
}

\lstnewenvironment{python}
{\lstset{style=python}}
{}


\begin{document}
	\thispagestyle{empty}  
	\noindent{
		\begin{tabular}{p{15cm}} 
			{\large \bf Artificial Intelligence} \\
			Università della Svizzera Italiana \\ Faculty of Informatics \\ 
			\today  \\
			\hline
			\\
		\end{tabular} 
		
		\vspace*{0.3cm} 
		
		\begin{center}
			{\Large \bf Assignment 2: Causal Inference}
			\vspace{2mm}
			
			{\bf Giorgia Adorni (giorgia.adorni@usi.ch)}
			
		\end{center}  
	}
	\vspace{0.4cm}
	
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Structure of the Network}

The problem modelled is a generic trip by car, influenced by factors such as the strike of public transport, road works or even the weather, and the delay that comes with it. 
The causal diagram that model this problem includes the following variables:
\begin{itemize}
	\item \texttt{Weather}: weather during the journey that should be \textit{sunny} or \textit{rainy}.
	\item \texttt{Strike}: \textit{true} if a strike of public transport takes place, \textit{false} otherwise.
	\item \texttt{RushHour}: \textit{true} if the time it’s rush hour, \textit{false} otherwise.
	\item \texttt{RoadConditions}: condition of the road floor, that depends on the weather, and should be \textit{dry} or \textit{wet}.
	\item \texttt{Mood}: mood of the driver, dependent on the weather, that is \textit{good} or \textit{bad}.
	\item \texttt{RoadWorks}: \textit{true} if there are road maintenance works in progress, \textit{false} otherwise. This variable depends on the conditions of the road.
	\item \texttt{Speed}: driving velocity, that should be \textit{slow} or \textit{fast}, dependent on the road condition, if it’s rush hour and if there are road works.
	\item \texttt{Danger}: danger incurred during the trip, that should be \textit{low} or \textit{high}, dependent on the driving velocity, the road conditions and if it’s rush hour. %FIXME not completely measurable 
	\item \texttt{Accident}: \textit{true} if an accident occurred during the trip, \textit{false} otherwise. It is influenced by the danger, the mood of the driver and if there is a strike of the public transport.
	\item \texttt{Delay}: \textit{true} if the trip is delayed, \textit{false} otherwise.
\end{itemize}

The objective of the network is highlight how weather and humour impacts on travel safety. 
The graph could provide valuable indications about the correlation between the driver humour and a delayed trip, or for example between the weather and the risk of an accident and also on how the road conditions influences car crashes.

Each node is connected by an arrow to one or more other nodes upon which it has a causal influence. Most of the arcs orientation are self-explaining. An exception was made for the \texttt{Mood} variable, that influences the accident risk and is caused only by the weather and not for example by the delay. 

\begin{figure}[H]
	\centering
	\includegraphics[width=\linewidth]{../code/network.pdf}	
	\caption{Bayesian Network}
	\label{fig:net}
\end{figure}

An arc can be inverted if and only if no v-structures, i.e. colliders in which the parents are not adjacent, are generated or destroyed in doing so.
 
In the model there are only two arrow that can be inverted, and these are the one that goes from the variable \texttt{Weather} to \texttt{Mood} and the one that goes from the variable \texttt{Weather} to \texttt{RoadConditions}.
In fact, even inverting the two arrows no v-structured are created, therefore the three graphs that are generated by the reversions of the two arcs are equivalent and not distinguishable by any statistical test.

Instead, the arc from \texttt{RoadWorks} to \texttt{RoadConditions} cannot be reverted since doing this a v-structure is created. Hence, the arc could only be turned on condition of turn also the one between 
\texttt{Weather} and \texttt{RoadConditions}.

\subsection*{D-Separation}
D-Separation tells when two variables are d-separated along a path (blocked), that means independent and when they are d-connected along a path (unblocked) or likely dependent.
They are actually independent if they are d-separated along all possible paths.
They are likely dependent if there is at least one unblocked path connecting them.

A path is blocked by a set of nodes if and only if the path contains a chain of nodes or a fork such that the middle node is in the set of nodes or if the path contains a collider such that the collision node and every descendant are not in the given set of nodes. 

\begin{itemize}
	\item X: \texttt{RushHour}, Y: \texttt{RoadConditions}:\\	
	Conditioning on one of the variables \texttt{Strike}, \texttt{RoadWorks} \texttt{Weather} or \texttt{Mood}, \texttt{RushHour} and \texttt{RoadConditions} are d-separated since the path from these two variables are all blocked.
	It is possible to write 
	\[ Y = \alpha + r_x X + r_a A + \epsilon \quad \text{with } r_a=0\]
	where A for example is \texttt{Strike}. 
	They are not actually independent since they are not d-separated along all the paths. For example, conditioning on one of the variables \texttt{Danger},\texttt{Speed}, \texttt{Accident} and \texttt{Delay}, the path from X to Y contains a collider in which the evidence is a collision node.
	In fact, all the variables d-connected are dependent in the real problem, for example \texttt{RushHour}, \texttt{RoadConditions} and \texttt{Danger}, while \texttt{RushHour}, \texttt{RoadConditions} and \texttt{Mood} are independent.
	
	\item X: \texttt{RushHour}, Y: \texttt{Strike}:\\
	Conditioning on one of the variables \texttt{Danger}, \texttt{RoadWorks}, \texttt{Weather}, \texttt{Speed} or \texttt{Mood}, \texttt{RushHour} and \texttt{Strike} are d-separated since the path from these two variables are all blocked.
	Instead, they are not d-separated along the paths that condition on variables \texttt{Accident} and \texttt{Delay} since in both the cases the paths contain a collider in which the given is the collision node. Hence, they are not independent.
	In the real problem, in fact, the d-connected variables are dependent, for example \texttt{RushHour}, \texttt{Strike} and \texttt{Danger}, while \texttt{RushHour}, \texttt{Strike} and \texttt{RoadWorks} are independent.
	
	\item X: \texttt{Speed}, Y: \texttt{Accident}:\\
	Are not d-separated given any of the variables of the domain.
	%FIXME
	"Danger", "Mood", "RoadConditions"
	
	\item X: \texttt{RoadConditions}, Y: \texttt{Strike}:\\
	In this case the same considerations made for the variables \texttt{RushHour} and \texttt{Strike} in example 2 apply.
	
	\item X: \texttt{Speed}, Y: \texttt{Mood}:\\
	Conditioning on one of the variables \texttt{RoadConditions} or \texttt{Weather}, \texttt{Speed} and \texttt{Mood} are d-separated since the path from these two variables are all blocked.
	Instead, they are not d-separated along the paths that condition on all the other variables, so they are not independent.
	The d-connected variables, for example \texttt{Speed}, \texttt{Mood} and \texttt{Danger}, are dependent in the real problem, while \texttt{Speed}, \texttt{Mood} and \texttt{RoadConditions} are not dependent.

\end{itemize}

\section{Conditional Probability Tables}

The Conditional Probability Tables (CPTs) of the variables of the model, that show all possible inputs and outcomes with their associated probabilities, are filled sometimes using information retrieved from online survey, other times are estimated based on common sense.
In case of the variable \texttt{Weather}, the prior probability is difficult to estimate because it is dependent on different factors, such as the location. For this reason I decided to use some information retrieved online\footlabel{note1}{\url{https://www.climatestotravel.com/climate/switzerland}} about the average precipitation in Lugano. Also the probabilities associated to the variable \texttt{Strike} are obtained from internet and referred to the number of strike of the public transport in Lugano.


\begin{figure}[H]
	\begin{center}	
	\begin{minipage}[c]{.3\textwidth}
		\centering
		\includegraphics[width=.5\linewidth]{../code/strike.pdf}	
		\caption*{Strike CPT}
		\label{fig:strike}
	\end{minipage}
	~
	\begin{minipage}[c]{.3\textwidth}
		\centering
		\includegraphics[width=.5\linewidth]{../code/weather.pdf}	
		\caption*{Weather CPT}
		\label{fig:weather}
	\end{minipage}
	~
	\begin{minipage}[c]{.3\textwidth}
		\centering
		\includegraphics[width=.5\linewidth]{../code/rushhour.pdf}	
		\caption*{RushHour CPT}
		\label{fig:rushhour}
	\end{minipage}

	\begin{minipage}[c]{.31\textwidth}
		\centering
		\includegraphics[width=.9\linewidth]{../code/roadconditions.pdf}	
		\caption*{RoadConditions CPT}
		\label{fig:roadconditions}
	\end{minipage}
	~
	\begin{minipage}[c]{.28\textwidth}
		\centering
		\includegraphics[width=.9\linewidth]{../code/mood.pdf}	
		\caption*{Mood CPT}
		\label{fig:Mood}
	\end{minipage}
	~
	\begin{minipage}[c]{.35\textwidth}
		\centering
		
		\includegraphics[width=.9\linewidth]{../code/roadworks.pdf}	
		\caption*{RoadWorks CPT}
		\label{fig:roadworks}
	\end{minipage}

	\begin{minipage}[c]{.5\textwidth}
		\centering
		\includegraphics[width=\linewidth]{../code/speed.pdf}	
		\caption*{Speed CPT}
		\label{fig:speed}
	\end{minipage}
	~
	\begin{minipage}[c]{.45\textwidth}
		\centering
		\includegraphics[width=\linewidth]{../code/danger.pdf}	
		\caption*{Danger CPT}
		\label{fig:danger}
	\end{minipage}
	\end{center}
	\end{figure}
	
	\begin{figure}[H]
	\begin{center}
	\centering
	\begin{minipage}[c]{.45\textwidth}
		\centering
		\includegraphics[width=.9\linewidth]{../code/accident.pdf}	
		\caption*{Accident CPT}
		\label{fig:accident}
	\end{minipage}
	~
	\begin{minipage}[c]{.45\textwidth}
		\centering
		\includegraphics[width=.9\linewidth]{../code/delay.pdf}	
		\caption*{Delay CPT}
		\label{fig:delay}
	\end{minipage}

\end{center}
\end{figure}

\section{Causal Inference}

\subsection*{Causal Effect}
Given the graph, and a pair of variable \texttt{X}: \texttt{Speed} and \texttt{Y}: \texttt{Accident}. In this case, \texttt{A}: \texttt{RoadConditions} and \texttt{B}: \texttt{RushHour} are the backdoor variables. Then the causal effect of \texttt{X} on \texttt{Y} is given by the following formula:
\begin{equation}
	\text{P}(Y = y \mid {do}(X = x)) = \sum_{A}^{}\sum_{B}^{}	\text{P}(Y = y \mid X = x, A = a, B = b)\text{P}(A = a, B = b)
\end{equation}
where $a$, $b$, $y$ and $x$ range over all the combinations of values that the associated variable can take.\\

\noindent Calculating the cases in which $\mathtt{Y}: \{ y_0=\mathtt{false}, y_1=\mathtt{true}\}$ given $\mathtt{X}: \{ x_0=\mathtt{slow}, x_1=\mathtt{fast}\}$ :

\begin{equation*}\begin{aligned}
\text{P}(Y = y_0 \mid {do}(X = x_0)) & = \sum_{A}^{}\sum_{B}^{}	\text{P}(Y = y_0 \mid X = x_0, A = a, B = b)\text{P}(A = a, B = b) = \\
& = 0.6062	
\end{aligned}\end{equation*}

\begin{equation*}\begin{aligned}
\text{P}(Y = y_1 \mid {do}(X = x_0)) & = \sum_{A}^{}\sum_{B}^{}	\text{P}(Y = y_1 \mid X = x_0, A = a, B = b)\text{P}(A = a, B = b) = \\
& = 0.3938
\end{aligned}\end{equation*}

\begin{equation*}\begin{aligned}
\text{P}(Y = y_0 \mid {do}(X = x_1)) & = \sum_{A}^{}\sum_{B}^{}	\text{P}(Y = y_0 \mid X = x_1, A = a, B = b)\text{P}(A = a, B = b) = \\
& = 0.4053	
\end{aligned}\end{equation*}

\begin{equation*}\begin{aligned}
\text{P}(Y = y_1 \mid {do}(X = x_1)) & = \sum_{A}^{}\sum_{B}^{}	\text{P}(Y = y_1 \mid X = x_1, A = a, B = b)\text{P}(A = a, B = b) = \\
& = 0.5947
\end{aligned}\end{equation*}


\subsection*{Confounders}

Identify possible confounders between X and Y.



• Would it be practically possible in your specific problem to perform also a randomized controlled study to disentangle the causal effect between the variables from their correlation?

\subsection*{Average Causal Effect}

Compute the ACE of X on Y.

\subsection*{Z-Specific Effect}

Choose another pair of variable (X,Y) (it can be also the previous one) and:
Choose another variable C such that it is possible to calculate the c-specific effect of X on Y and calculate it.


• Identify a minimal set of variables that must be measured in order to estimate the c-specific effect of X on Y.



We calculate the C-specific effect of X on Y that in this case can be calculated:

$$P(Y=y|do(X=x), C=c)= \sum_{z} P(Y=y|X=x, C=c, Z=z) P(Z=z|C=c)$$

because $\{Z,C\}$ satisfies Rule 2.



\subsection*{Conditional Intervention}
• Choose a function g and compute the effect of the conditional intervention of X=g(C) on Y.

\subsection*{Mediation and Controlled Direct Effect}
Choose another pair of variable (X,Y) (it can be also the previous one) and:
• Identify possible mediating variables between X and Y and calculate the CDE of Y changing the value of X.

\section{Simulation}
Suppose that you can’t measure some parents of variable X chosen in every point of “Causal Inference”.
Repeat the “Causal Inference” part of the exercise considering this new situation.

\section{Comment on the Results}
What kind of experience have you got with this model? E.g., is the causal model responding in a sensible way to your queries? What should be changed/modified to make it more realistic?


\end{document}
